# 小组评分功能说明

## 功能概述

小组评分功能允许教师对整个小组进行统一评价，系统会自动将评分应用到该组的所有成员。例如，给第1组打3颗星，则第1组的所有成员都会收到3颗星的评价。

## 使用流程

### 1. 设置分组

在使用小组评分功能之前，需要先在"课堂互动分组管理"页面设置分组：

1. 在课堂教学主界面点击"分组 设置"按钮
2. 拖拽学生到不同的小组（最多支持8个小组）
3. 点击"完成确认并保存"按钮保存分组

### 2. 进行小组评分

1. 在课堂教学主界面点击"小组 互动"按钮
2. 系统会显示小组选择弹窗，展示所有已设置的小组
3. 点击要评价的小组卡片
4. 在评价弹窗中：
   - 查看该组的所有成员
   - 点击星星选择评分（1-5星）
   - 可选：添加评语标签（积极/消极）
   - 可选：添加文字备注
5. 点击"确认评价"按钮提交

### 3. 评价结果

- 系统会为该组的每个成员创建一条评价记录
- 所有成员获得相同的评分、标签和备注
- 当堂得星总计会增加：评分 × 组员数量
- 最近评价学生卡片会显示小组信息

## 技术实现

### 核心函数

#### 1. `showGroupSelectionModal(doc, groupData, cls)`
显示小组选择弹窗，让教师选择要评价的小组。

参数：
- `doc`: 文档对象
- `groupData`: 分组数据（从数据库加载）
- `cls`: 当前班级对象

#### 2. `showGroupEvaluationModal(doc, groupNumber, groupMembers, cls)`
显示小组评价弹窗，让教师为选定的小组打分。

参数：
- `doc`: 文档对象
- `groupNumber`: 小组编号（1-8）
- `groupMembers`: 小组成员数组
- `cls`: 当前班级对象

#### 3. `submitGroupEvaluation(classId, members, score, tags, comment)`
批量提交小组评价，为每个成员创建评价记录。

参数：
- `classId`: 班级ID
- `members`: 成员数组
- `score`: 评分（1-5）
- `tags`: 标签数组
- `comment`: 备注文字

返回：
```javascript
{
  success: true/false,
  successCount: 成功数量,
  failCount: 失败数量,
  error: 错误信息（如果有）
}
```

#### 4. `bindGroupEvaluationHandler()`
绑定"小组 互动"按钮的点击事件。

### 数据流程

```
点击"小组 互动"按钮
  ↓
检查是否选择了班级
  ↓
从数据库加载分组数据 (loadGroupData)
  ↓
显示小组选择弹窗
  ↓
点击小组卡片
  ↓
显示小组评价弹窗
  ↓
选择评分、标签、备注
  ↓
点击"确认评价"
  ↓
批量提交评价 (submitGroupEvaluation)
  ↓
为每个成员调用 /api/evaluations API
  ↓
更新统计数据
  ↓
显示成功提示
```

## UI 设计

### 小组选择弹窗

- 网格布局，最多显示8个小组
- 每个小组卡片显示：
  - 小组图标（👥）
  - 小组编号（第 X 组）
  - 成员数量
  - 不同颜色区分
- 空小组显示为灰色，不可点击

### 小组评价弹窗

- 标题：👥 小组互动评价
- 副标题：显示小组编号和成员数量
- 小组信息区：
  - 虚线边框的信息框
  - 显示所有成员的名字标签
- 评分区：5颗星星，可点击选择
- 标签区：积极标签（蓝色）和消极标签（红色）
- 备注区：可选的文本输入框
- 按钮：取消评价 / 确认评价

## 样式定制

所有样式都内联在 JavaScript 中，使用 `bridge-group-eval-modal` 和 `bridge-group-select-modal` 作为 ID 前缀。

主要颜色：
- 主色调：#6366f1（靛蓝色）
- 成功色：#10b981（绿色）
- 警告色：#f43f5e（红色）
- 小组颜色：8种不同的颜色区分不同小组

## 注意事项

1. **必须先设置分组**：如果没有分组数据，点击"小组 互动"按钮会提示先设置分组
2. **必须选择班级**：评价前必须选择当前班级
3. **批量提交**：评价会为每个成员单独提交，如果部分失败会在控制台显示错误
4. **星数统计**：当堂得星总计 = 评分 × 组员数量
5. **数据持久化**：所有评价记录都保存在数据库的 `evaluations` 表中

## 测试建议

### 手动测试清单

- [ ] 未设置分组时点击"小组 互动"按钮，应提示先设置分组
- [ ] 设置分组后，小组选择弹窗应正确显示所有小组
- [ ] 空小组应显示为灰色且不可点击
- [ ] 点击小组卡片后，应显示该组的所有成员
- [ ] 评分功能正常（星星高亮、评分文字更新）
- [ ] 标签选择功能正常（可多选、可取消）
- [ ] 提交评价后，所有成员都应收到相同的评价
- [ ] 当堂得星总计应正确增加
- [ ] 最近评价学生卡片应显示小组信息
- [ ] 在 Chrome 和 Edge 浏览器中测试
- [ ] 测试响应式布局（桌面和移动端宽度）

## 浏览器兼容性

- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14+

## 相关文件

- `assets/static/bridge.js` - 主要实现代码
- `assets/static/group-management.js` - 分组数据加载
- `课堂互动分组管理.html` - 分组设置页面
- `课堂教学主界面.html` - 主界面（包含"小组 互动"按钮）
- `server/src/routes/data.js` - 评价API后端
- `server/src/routes/kv.js` - 分组数据存储API
