<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯¾å ‚äº’åŠ¨åˆ†ç»„ç®¡ç†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
    }

    .header-title h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .header-title p {
      font-size: 14px;
      color: #6b7280;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 400px;
      gap: 24px;
    }

    .group-card {
      background: white;
      border: 2px dashed #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      min-height: 400px;
      transition: all 0.3s;
    }

    .group-card.group-1 { border-color: #3b82f6; background: #eff6ff; }
    .group-card.group-2 { border-color: #ec4899; background: #fdf2f8; }
    .group-card.group-3 { border-color: #10b981; background: #f0fdf4; }
    .group-card.group-4 { border-color: #f59e0b; background: #fffbeb; }

    .group-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .group-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .group-icon {
      font-size: 20px;
    }

    .group-name {
      font-size: 18px;
      font-weight: 700;
    }

    .group-card.group-1 .group-name { color: #3b82f6; }
    .group-card.group-2 .group-name { color: #ec4899; }
    .group-card.group-3 .group-name { color: #10b981; }
    .group-card.group-4 .group-name { color: #f59e0b; }

    .group-count {
      background: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
    }

    .group-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .group-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      background: white;
      color: #6b7280;
      transition: all 0.2s;
    }

    .group-actions button:hover {
      background: #f3f4f6;
    }

    .student-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .student-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      transition: all 0.2s;
    }

    .student-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .student-item.dragging {
      opacity: 0.5;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .student-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 600;
    }

    .student-name {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    .student-remove {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.2s;
    }

    .student-item:hover .student-remove {
      opacity: 1;
    }

    .student-remove:hover {
      background: #fee2e2;
    }

    .sidebar {
      background: #f9fafb;
      border-radius: 16px;
      padding: 20px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .sidebar-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .sidebar-title h3 {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
    }

    .sidebar-title p {
      font-size: 12px;
      color: #6b7280;
    }

    .unassigned-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 500px;
      overflow-y: auto;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .empty-state-text {
      font-size: 14px;
    }

    .footer-actions {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .footer-info {
      font-size: 12px;
      color: #6b7280;
    }

    .footer-buttons {
      display: flex;
      gap: 12px;
    }

    .btn-large {
      padding: 12px 32px;
      font-size: 16px;
    }

    .drag-over {
      border-style: solid;
      border-width: 3px;
      background: rgba(255, 255, 255, 0.8);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <div class="header-icon">ğŸ‘¥</div>
        <div class="header-title">
          <h1>è¯¾å ‚äº’åŠ¨åˆ†ç»„ç®¡ç†</h1>
          <p id="headerSubtitle">æ‹–æ‹½å­¦ç”Ÿå¡ç‰‡è¿›è¡Œåˆ†ç»„ Â· ç§‘å­¦åˆ†ç»„ä¼˜åŒ–è¯¾å ‚ç®¡ç†</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="autoAssign()">
          ğŸ² è‡ªåŠ¨åˆ†ç»„
        </button>
        <button class="btn btn-secondary" onclick="clearAll()">
          ğŸ”„ é‡ç½®åˆ†ç»„
        </button>
        <button class="btn btn-secondary" onclick="window.close()">
          âœ• å…³é—­
        </button>
      </div>
    </div>

    <div class="main-content">
      <div class="group-card group-1" data-group="1" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
        <div class="group-header">
          <div class="group-title">
            <span class="group-icon">ğŸ‘¥</span>
            <span class="group-name">ç¬¬ 1 ç»„</span>
          </div>
          <span class="group-count">å…¨å‘˜: <span id="count-1">0</span></span>
        </div>
        <div class="group-actions">
          <button onclick="clearGroup(1)">æ¸…ç©ºæˆå‘˜</button>
          <button onclick="addMember(1)">ä»æ± æ·»åŠ </button>
        </div>
        <div class="student-list" id="group-1"></div>
      </div>

      <div class="group-card group-2" data-group="2" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
        <div class="group-header">
          <div class="group-title">
            <span class="group-icon">ğŸ‘¥</span>
            <span class="group-name">ç¬¬ 2 ç»„</span>
          </div>
          <span class="group-count">å…¨å‘˜: <span id="count-2">0</span></span>
        </div>
        <div class="group-actions">
          <button onclick="clearGroup(2)">æ¸…ç©ºæˆå‘˜</button>
          <button onclick="addMember(2)">ä»æ± æ·»åŠ </button>
        </div>
        <div class="student-list" id="group-2"></div>
      </div>

      <div class="group-card group-3" data-group="3" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
        <div class="group-header">
          <div class="group-title">
            <span class="group-icon">ğŸ‘¥</span>
            <span class="group-name">ç¬¬ 3 ç»„</span>
          </div>
          <span class="group-count">å…¨å‘˜: <span id="count-3">0</span></span>
        </div>
        <div class="group-actions">
          <button onclick="clearGroup(3)">æ¸…ç©ºæˆå‘˜</button>
          <button onclick="addMember(3)">ä»æ± æ·»åŠ </button>
        </div>
        <div class="student-list" id="group-3"></div>
      </div>

      <div class="group-card group-4" data-group="4" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
        <div class="group-header">
          <div class="group-title">
            <span class="group-icon">ğŸ‘¥</span>
            <span class="group-name">ç¬¬ 4 ç»„</span>
          </div>
          <span class="group-count">å…¨å‘˜: <span id="count-4">0</span></span>
        </div>
        <div class="group-actions">
          <button onclick="clearGroup(4)">æ¸…ç©ºæˆå‘˜</button>
          <button onclick="addMember(4)">ä»æ± æ·»åŠ </button>
        </div>
        <div class="student-list" id="group-4"></div>
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-icon">ğŸ“‹</div>
        <div class="sidebar-title">
          <h3>å¾…åˆ†é…æˆå‘˜</h3>
          <p>æœªåˆ†ç»„: <span id="unassigned-count">0</span></p>
        </div>
      </div>
      <div class="unassigned-list" id="unassigned-pool" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
        <div class="empty-state">
          <div class="empty-state-icon">âœ…</div>
          <div class="empty-state-text">å…¨éƒ¨å·²åˆ†é…å®Œæ¯•<br>æ‹–æ‹½å­¦ç”Ÿå¡ç‰‡åˆ°æ­¤å¤„å–æ¶ˆåˆ†ç»„</div>
        </div>
      </div>
    </div>

    <div class="footer-actions">
      <div class="footer-info">
        ğŸ’¡ æç¤º: æ‹–æ‹½å­¦ç”Ÿå¡ç‰‡åˆ°ä¸åŒåˆ†ç»„ï¼Œæˆ–ç‚¹å‡»"è‡ªåŠ¨åˆ†ç»„"æŒ‰é’®è¿›è¡Œæ™ºèƒ½åˆ†é…
      </div>
      <div class="footer-buttons">
        <button class="btn btn-secondary btn-large" onclick="window.close()">å–æ¶ˆ</button>
        <button class="btn btn-primary btn-large" onclick="saveGroups()">å®Œæˆç¡®è®¤å¹¶ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // å­¦ç”Ÿæ•°æ®ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    let students = [];
    let currentClassName = '';

    // åˆ†ç»„æ•°æ®
    const groups = {
      1: [],
      2: [],
      3: [],
      4: [],
      unassigned: []
    };

    // è·å–å½“å‰ç­çº§ä¿¡æ¯
    async function getCurrentClassInfo() {
      try {
        const currentClassId = localStorage.getItem('currentClassId');
        
        if (!currentClassId) {
          return null;
        }

        // è·å–ç­çº§ä¿¡æ¯
        const response = await fetch('/api/classes', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('è·å–ç­çº§ä¿¡æ¯å¤±è´¥');
        }

        const classes = await response.json();
        const currentClass = classes.find(c => c.id === parseInt(currentClassId));
        
        if (currentClass) {
          currentClassName = currentClass.name + (currentClass.grade ? ` (${currentClass.grade})` : '');
          // æ›´æ–°é¡µé¢æ ‡é¢˜
          const subtitle = document.getElementById('headerSubtitle');
          if (subtitle) {
            subtitle.textContent = `å½“å‰ç­çº§: ${currentClassName} Â· æ‹–æ‹½å­¦ç”Ÿå¡ç‰‡è¿›è¡Œåˆ†ç»„`;
          }
        }

        return currentClass;
      } catch (error) {
        console.error('è·å–ç­çº§ä¿¡æ¯å¤±è´¥:', error);
        return null;
      }
    }

    // ä»æ•°æ®åº“åŠ è½½å­¦ç”Ÿæ•°æ®
    async function loadStudentsFromDB() {
      try {
        // ä»localStorageè·å–å½“å‰é€‰æ‹©çš„ç­çº§ID
        const currentClassId = localStorage.getItem('currentClassId');
        
        if (!currentClassId) {
          console.warn('æœªé€‰æ‹©ç­çº§');
          showError('è¯·å…ˆåœ¨è¯¾å ‚æ•™å­¦ä¸»ç•Œé¢é€‰æ‹©ç­çº§');
          return [];
        }

        console.log('æ­£åœ¨åŠ è½½ç­çº§å­¦ç”Ÿæ•°æ®ï¼Œç­çº§ID:', currentClassId);
        
        const response = await fetch(`/api/classes/${currentClassId}/students`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        console.log('æˆåŠŸåŠ è½½å­¦ç”Ÿæ•°æ®:', data);
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        return data.map(student => ({
          id: student.id,
          name: student.name,
          studentNo: student.studentNo
        }));
      } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', error);
        showError('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return [];
      }
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      const container = document.querySelector('.container');
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #fee2e2;
        color: #dc2626;
        padding: 16px 24px;
        border-radius: 12px;
        border: 2px solid #fca5a5;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      `;
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // ä»æ•°æ®åº“åŠ è½½å·²ä¿å­˜çš„åˆ†ç»„æ•°æ®
    async function loadSavedGroups() {
      try {
        const currentClassId = localStorage.getItem('currentClassId');
        if (!currentClassId) {
          console.warn('æœªé€‰æ‹©ç­çº§ï¼Œæ— æ³•åŠ è½½åˆ†ç»„æ•°æ®');
          return false;
        }

        // ä»æ•°æ®åº“è·å–åˆ†ç»„æ•°æ®
        const namespace = `class_${currentClassId}_groups`;
        const response = await fetch(`/api/kv/snapshot?namespace=${encodeURIComponent(namespace)}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          console.warn('è·å–åˆ†ç»„æ•°æ®å¤±è´¥:', response.status);
          return false;
        }

        const result = await response.json();
        const saved = result.items?.groupData;
        
        if (saved) {
          const data = JSON.parse(saved);
          console.log('ä»æ•°æ®åº“åŠ è½½å·²ä¿å­˜çš„åˆ†ç»„æ•°æ®:', data);
          
          // æ¢å¤åˆ†ç»„æ•°æ®
          groups[1] = data.group1 || [];
          groups[2] = data.group2 || [];
          groups[3] = data.group3 || [];
          groups[4] = data.group4 || [];
          groups.unassigned = data.unassigned || [];
          
          return true;
        }
      } catch (error) {
        console.error('åŠ è½½ä¿å­˜çš„åˆ†ç»„æ•°æ®å¤±è´¥:', error);
      }
      return false;
    }

    // åˆå§‹åŒ–é¡µé¢
    async function init() {
      // æ˜¾ç¤ºåŠ è½½æç¤º
      const pool = document.getElementById('unassigned-pool');
      pool.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><div class="empty-state-text">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</div></div>';
      
      // ä»æ•°æ®åº“åŠ è½½å­¦ç”Ÿæ•°æ®
      students = await loadStudentsFromDB();
      
      if (students.length === 0) {
        pool.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><div class="empty-state-text">æœªæ‰¾åˆ°å­¦ç”Ÿæ•°æ®<br>è¯·ç¡®ä¿å·²é€‰æ‹©ç­çº§</div></div>';
        return;
      }

      // å°è¯•åŠ è½½å·²ä¿å­˜çš„åˆ†ç»„
      const hasSavedGroups = await loadSavedGroups();
      
      if (!hasSavedGroups) {
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„åˆ†ç»„ï¼Œå°†æ‰€æœ‰å­¦ç”Ÿæ”¾å…¥å¾…åˆ†é…æ± 
        groups.unassigned = [...students];
      } else {
        // éªŒè¯ä¿å­˜çš„åˆ†ç»„æ•°æ®ä¸­çš„å­¦ç”Ÿæ˜¯å¦è¿˜å­˜åœ¨
        const currentStudentIds = new Set(students.map(s => s.id));
        
        // æ¸…ç†ä¸å­˜åœ¨çš„å­¦ç”Ÿ
        for (let i = 1; i <= 4; i++) {
          groups[i] = groups[i].filter(s => currentStudentIds.has(s.id));
        }
        groups.unassigned = groups.unassigned.filter(s => currentStudentIds.has(s.id));
        
        // æ‰¾å‡ºæ–°å¢çš„å­¦ç”Ÿï¼ˆåœ¨æ•°æ®åº“ä¸­ä½†ä¸åœ¨ä»»ä½•åˆ†ç»„ä¸­ï¼‰
        const assignedIds = new Set([
          ...groups[1].map(s => s.id),
          ...groups[2].map(s => s.id),
          ...groups[3].map(s => s.id),
          ...groups[4].map(s => s.id),
          ...groups.unassigned.map(s => s.id)
        ]);
        
        const newStudents = students.filter(s => !assignedIds.has(s.id));
        if (newStudents.length > 0) {
          console.log('å‘ç°æ–°å¢å­¦ç”Ÿ:', newStudents);
          groups.unassigned.push(...newStudents);
        }
      }

      // æ¸²æŸ“æ‰€æœ‰åˆ†ç»„
      renderGroup(1);
      renderGroup(2);
      renderGroup(3);
      renderGroup(4);
      renderUnassigned();
      updateCounts();
    }

    // æ¸²æŸ“æœªåˆ†é…å­¦ç”Ÿ
    function renderUnassigned() {
      const pool = document.getElementById('unassigned-pool');
      pool.innerHTML = '';
      
      if (groups.unassigned.length === 0) {
        pool.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœ…</div>
            <div class="empty-state-text">å…¨éƒ¨å·²åˆ†é…å®Œæ¯•<br>æ‹–æ‹½å­¦ç”Ÿå¡ç‰‡åˆ°æ­¤å¤„å–æ¶ˆåˆ†ç»„</div>
          </div>
        `;
        return;
      }

      groups.unassigned.forEach(student => {
        pool.appendChild(createStudentCard(student, 'unassigned'));
      });
    }

    // æ¸²æŸ“åˆ†ç»„
    function renderGroup(groupId) {
      const groupEl = document.getElementById(`group-${groupId}`);
      groupEl.innerHTML = '';
      
      if (groups[groupId].length === 0) {
        groupEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘‹</div>
            <div class="empty-state-text">æ‹–æ‹½æˆå‘˜åˆ°æ­¤å¤„<br>æˆ–ç‚¹å‡»"ä»æ± æ·»åŠ "</div>
          </div>
        `;
        return;
      }

      groups[groupId].forEach(student => {
        groupEl.appendChild(createStudentCard(student, groupId));
      });
    }

    // åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
    function createStudentCard(student, groupId) {
      const card = document.createElement('div');
      card.className = 'student-item';
      card.draggable = true;
      card.dataset.studentId = student.id;
      card.dataset.groupId = groupId;
      
      card.innerHTML = `
        <div class="student-info">
          <div class="student-avatar">${student.name.charAt(0)}</div>
          <span class="student-name">${student.name}</span>
        </div>
        <button class="student-remove" onclick="removeStudent(${student.id}, '${groupId}')">âœ•</button>
      `;

      card.addEventListener('dragstart', drag);
      card.addEventListener('dragend', dragEnd);
      
      return card;
    }

    // æ‹–æ‹½å¼€å§‹
    function drag(e) {
      e.dataTransfer.setData('studentId', e.target.dataset.studentId);
      e.dataTransfer.setData('fromGroup', e.target.dataset.groupId);
      e.target.classList.add('dragging');
    }

    // æ‹–æ‹½ç»“æŸ
    function dragEnd(e) {
      e.target.classList.remove('dragging');
    }

    // å…è®¸æ”¾ç½®
    function allowDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    // ç¦»å¼€æ‹–æ‹½åŒºåŸŸ
    function dragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    // æ”¾ç½®
    function drop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      const studentId = parseInt(e.dataTransfer.getData('studentId'));
      const fromGroup = e.dataTransfer.getData('fromGroup');
      
      let toGroup;
      if (e.currentTarget.id === 'unassigned-pool') {
        toGroup = 'unassigned';
      } else {
        toGroup = e.currentTarget.dataset.group;
      }

      if (fromGroup === toGroup) return;

      moveStudent(studentId, fromGroup, toGroup);
    }

    // ç§»åŠ¨å­¦ç”Ÿ
    function moveStudent(studentId, fromGroup, toGroup) {
      const student = groups[fromGroup].find(s => s.id === studentId);
      if (!student) return;

      groups[fromGroup] = groups[fromGroup].filter(s => s.id !== studentId);
      groups[toGroup].push(student);

      if (fromGroup === 'unassigned') {
        renderUnassigned();
      } else {
        renderGroup(fromGroup);
      }

      if (toGroup === 'unassigned') {
        renderUnassigned();
      } else {
        renderGroup(toGroup);
      }

      updateCounts();
    }

    // ç§»é™¤å­¦ç”Ÿ
    function removeStudent(studentId, groupId) {
      moveStudent(studentId, groupId, 'unassigned');
    }

    // æ¸…ç©ºåˆ†ç»„
    function clearGroup(groupId) {
      if (groups[groupId].length === 0) return;
      
      if (confirm(`ç¡®å®šè¦æ¸…ç©ºç¬¬ ${groupId} ç»„çš„æ‰€æœ‰æˆå‘˜å—ï¼Ÿ`)) {
        groups.unassigned.push(...groups[groupId]);
        groups[groupId] = [];
        renderGroup(groupId);
        renderUnassigned();
        updateCounts();
      }
    }

    // ä»æ± ä¸­æ·»åŠ æˆå‘˜
    function addMember(groupId) {
      if (groups.unassigned.length === 0) {
        alert('æ²¡æœ‰å¯åˆ†é…çš„å­¦ç”Ÿäº†ï¼');
        return;
      }

      const student = groups.unassigned.shift();
      groups[groupId].push(student);
      renderGroup(groupId);
      renderUnassigned();
      updateCounts();
    }

    // è‡ªåŠ¨åˆ†ç»„
    function autoAssign() {
      if (confirm('è‡ªåŠ¨åˆ†ç»„å°†æ¸…ç©ºç°æœ‰åˆ†ç»„å¹¶é‡æ–°åˆ†é…ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
        // æ”¶é›†æ‰€æœ‰å­¦ç”Ÿ
        const allStudents = [...students];
        
        // æ¸…ç©ºæ‰€æœ‰åˆ†ç»„
        groups[1] = [];
        groups[2] = [];
        groups[3] = [];
        groups[4] = [];
        groups.unassigned = [];

        // æ‰“ä¹±é¡ºåº
        for (let i = allStudents.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [allStudents[i], allStudents[j]] = [allStudents[j], allStudents[i]];
        }

        // å¹³å‡åˆ†é…
        allStudents.forEach((student, index) => {
          const groupId = (index % 4) + 1;
          groups[groupId].push(student);
        });

        // æ¸²æŸ“æ‰€æœ‰åˆ†ç»„
        renderGroup(1);
        renderGroup(2);
        renderGroup(3);
        renderGroup(4);
        renderUnassigned();
        updateCounts();
      }
    }

    // é‡ç½®æ‰€æœ‰åˆ†ç»„
    function clearAll() {
      if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰åˆ†ç»„å—ï¼Ÿæ‰€æœ‰å­¦ç”Ÿå°†è¿”å›å¾…åˆ†é…æ± ã€‚')) {
        groups.unassigned = [...students];
        groups[1] = [];
        groups[2] = [];
        groups[3] = [];
        groups[4] = [];
        
        renderGroup(1);
        renderGroup(2);
        renderGroup(3);
        renderGroup(4);
        renderUnassigned();
        updateCounts();
      }
    }

    // æ›´æ–°è®¡æ•°
    function updateCounts() {
      document.getElementById('count-1').textContent = groups[1].length;
      document.getElementById('count-2').textContent = groups[2].length;
      document.getElementById('count-3').textContent = groups[3].length;
      document.getElementById('count-4').textContent = groups[4].length;
      document.getElementById('unassigned-count').textContent = groups.unassigned.length;
    }

    // ä¿å­˜åˆ†ç»„åˆ°æ•°æ®åº“
    async function saveGroups() {
      try {
        const currentClassId = localStorage.getItem('currentClassId');
        if (!currentClassId) {
          alert('æœªé€‰æ‹©ç­çº§ï¼Œæ— æ³•ä¿å­˜åˆ†ç»„æ•°æ®');
          return;
        }

        const groupData = {
          group1: groups[1],
          group2: groups[2],
          group3: groups[3],
          group4: groups[4],
          unassigned: groups.unassigned,
          savedAt: new Date().toISOString(),
          className: currentClassName
        };

        // ä¿å­˜åˆ°æ•°æ®åº“
        const namespace = `class_${currentClassId}_groups`;
        const response = await fetch('/api/kv/upsert', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            namespace: namespace,
            key: 'groupData',
            value: JSON.stringify(groupData)
          })
        });

        if (!response.ok) {
          throw new Error(`ä¿å­˜å¤±è´¥: ${response.status}`);
        }

        const result = await response.json();
        if (result.ok) {
          // åŒæ—¶ä¿å­˜åˆ° localStorage ä½œä¸ºå¤‡ä»½ï¼ˆç”¨äºè·¨çª—å£é€šä¿¡ï¼‰
          localStorage.setItem('classroomGroups', JSON.stringify(groupData));
          
          alert('åˆ†ç»„å·²ä¿å­˜æˆåŠŸï¼');
          console.log('ä¿å­˜çš„åˆ†ç»„æ•°æ®:', groupData);
        } else {
          throw new Error('ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜åˆ†ç»„æ•°æ®å¤±è´¥:', error);
        alert('ä¿å­˜åˆ†ç»„æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = async function() {
      // è·å–å½“å‰ç­çº§ä¿¡æ¯
      const classInfo = await getCurrentClassInfo();
      
      if (!classInfo) {
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const pool = document.getElementById('unassigned-pool');
        pool.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">è¯·å…ˆåœ¨è¯¾å ‚æ•™å­¦ä¸»ç•Œé¢é€‰æ‹©ç­çº§</div></div>';
        return;
      }

      // åŠ è½½å­¦ç”Ÿæ•°æ®
      await init();
    };
  </script>
</body>
</html>
