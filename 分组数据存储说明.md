# 分组数据存储说明

## 功能概述

每个老师对于每个主授班级的分组设置现在会自动保存到数据库中，便于下次直接读取和使用。

## 技术实现

### 数据存储位置

- 使用现有的 `kv_store` 表存储分组数据
- Namespace 格式：`class_{classId}_groups`
- Key：`groupData`
- Value：JSON 格式的分组数据

### 数据结构

```json
{
  "group1": [
    { "id": 1, "name": "张三", "studentNo": "001" },
    { "id": 2, "name": "李四", "studentNo": "002" }
  ],
  "group2": [...],
  "group3": [...],
  "group4": [...],
  "unassigned": [...],
  "savedAt": "2024-01-01T12:00:00.000Z",
  "className": "一年级1班"
}
```

## 使用流程

### 1. 保存分组

在"课堂互动分组管理"页面中：
1. 拖拽学生到不同分组
2. 点击"完成确认并保存"按钮
3. 系统自动将分组数据保存到数据库

### 2. 加载分组

当打开"课堂互动分组管理"页面时：
1. 系统自动从数据库加载该班级的分组数据
2. 如果有保存的分组，自动恢复到上次的状态
3. 如果没有保存的分组，所有学生默认在"待分配成员"池中

### 3. 跨页面使用

在"课堂教学主界面"等其他页面：
```javascript
// 加载当前班级的分组数据
const groupData = await window.loadGroupData();
if (groupData) {
  console.log('第1组成员:', groupData.group1);
  console.log('第2组成员:', groupData.group2);
  // ...
}
```

## API 接口

### 保存分组数据

```javascript
POST /api/kv/upsert
Content-Type: application/json

{
  "namespace": "class_123_groups",
  "key": "groupData",
  "value": "{\"group1\":[...],\"group2\":[...],...}"
}
```

### 获取分组数据

```javascript
GET /api/kv/snapshot?namespace=class_123_groups

Response:
{
  "namespace": "class_123_groups",
  "items": {
    "groupData": "{\"group1\":[...],\"group2\":[...],...}"
  }
}
```

## 数据隔离

- 每个班级的分组数据完全独立
- 不同班级的分组互不影响
- 切换班级时自动加载对应班级的分组数据

## 兼容性

- 保留了 localStorage 作为备份机制
- 支持跨窗口通信（通过 storage 事件）
- 向后兼容旧的 localStorage 数据

## 注意事项

1. 必须先选择班级才能保存和加载分组数据
2. 分组数据与班级 ID 绑定，切换班级会加载不同的分组
3. 如果学生名单发生变化（新增或删除学生），系统会自动处理：
   - 删除的学生会从分组中移除
   - 新增的学生会自动加入"待分配成员"池
